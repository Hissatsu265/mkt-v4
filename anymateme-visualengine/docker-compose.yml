version: '3.8'
services:
  # FastAPI Application
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: animatemehub-api:v2
    container_name: animatemehub-api
    ports:
      - "8001:8001"
    environment:
      - OLLAMA_SERVICE_1_URL=http://ollama-1:11434
      - OLLAMA_SERVICE_2_URL=http://ollama-2:11434
    networks:
      - ollama-network
    depends_on:
      - ollama-1
      - ollama-2
    restart: unless-stopped

  # Ollama Services (using your existing configuration)
  ollama-1:
    image: ollama/ollama:latest
    container_name: ollama-1
    ports:
      - "12434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ollama-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  model-puller:
    image: debian:bullseye-slim
    container_name: model-puller
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ollama-network
    depends_on:
      - ollama-1
    restart: "no"
    command: >
      bash -c "
        echo 'Waiting for Ollama server to start...' &&
        sleep 10 &&
        apt-get update &&
        apt-get install -y curl &&
        curl -fsSL https://ollama.com/install.sh | sh &&
        export OLLAMA_HOST=http://ollama-1:11434 &&
        ollama pull phi4 &&
        echo 'Pulled phi4 model!' &&
        echo 'Creating extended model...' &&
        echo 'FROM phi4:latest
        PARAMETER num_ctx 3072' > /tmp/Modelfile &&
        ollama create phi4-extended -f /tmp/Modelfile &&
        echo 'Extended model created successfully!'
      "

  ollama-2:
    image: ollama/ollama:latest
    container_name: ollama-2
    ports:
      - "12435:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ollama-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      - model-puller

networks:
  ollama-network:
    driver: bridge

volumes:
  ollama_data: