<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyMateMe Visual Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #111111;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .generate-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .image-area {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #0f0f0f;
            overflow-y: auto;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
            max-width: 1200px;
            margin-top: 1rem;
        }

        .image-container {
            width: 100%;
            min-height: 300px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 1rem;
        }

        .image-label {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 5;
        }

        .placeholder-text {
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .controls-panel {
            width: 350px;
            background: #1a1a1a;
            border-left: 1px solid #333;
            padding: 2rem;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #d1d5db;
        }

        .control-input {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .control-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .prompt-textarea {
            height: 100px;
            resize: vertical;
        }

        .upload-area {
            border: 2px dashed #444;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #2a2a2a;
            margin-top: 0.5rem;
        }

        .upload-area:hover {
            border-color: #6366f1;
            background: #333;
        }

        .upload-area.dragover {
            border-color: #6366f1;
            background: #333;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .upload-text {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        .file-input {
            display: none;
        }

        .preview-container {
            margin-top: 1rem;
            display: none;
            position: relative;
        }

        .preview-image {
            width: 100%;
            border-radius: 0.5rem;
            max-height: 200px;
            object-fit: cover;
        }

        .remove-image-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            line-height: 1;
        }

        .remove-image-btn:hover {
            background: #b91c1c;
        }

        .style-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .style-option, .ratio-option, .quality-option {
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .style-option:hover, .ratio-option:hover, .quality-option:hover {
            border-color: #6366f1;
        }

        .style-option.active, .ratio-option.active, .quality-option.active {
            background: #6366f1;
            border-color: #6366f1;
        }

        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .loading-content {
            text-align: center;
            max-width: 300px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #333;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .progress-container {
            width: 200px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem auto;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: move 1s linear infinite;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .loading-message {
            color: #d1d5db;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .loading-steps {
            margin-top: 1rem;
            text-align: left;
        }

        .loading-step {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .loading-step.active {
            color: #6366f1;
        }

        .loading-step.completed {
            color: #10b981;
        }

        .step-icon {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }

        .step-icon.active {
            animation: pulse 1.5s infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes move {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .error-message {
            background: #dc2626;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            width: 100%;
            max-width: 1200px;
        }

        .success-message {
            background: #059669;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            width: 100%;
            max-width: 1200px;
        }

        .info-panel {
            background: #2a2a2a;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: #9ca3af;
            width: 100%;
            max-width: 1200px;
        }

        .job-id-display {
            background: #2a2a2a;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.7rem;
            color: #9ca3af;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <header class="header">
                <h1>AnyMateMe Visual Engine</h1>
                <button class="generate-btn" onclick="generateImage()">Generate</button>
            </header>
            
            <div class="content">
                <div class="image-area">
                    <div class="error-message" id="errorMessage"></div>
                    <div class="success-message" id="successMessage"></div>
                    
                    <div class="images-grid" id="imagesGrid" style="display: none;">
                        <div class="image-container" id="imageContainer1">
                            <div class="image-label">Image 1</div>
                            <div class="placeholder-text">
                                <h3>Image 1</h3>
                                <p>Waiting for generation...</p>
                            </div>
                        </div>
                        <div class="image-container" id="imageContainer2">
                            <div class="image-label">Image 2</div>
                            <div class="placeholder-text">
                                <h3>Image 2</h3>
                                <p>Waiting for generation...</p>
                            </div>
                        </div>
                    </div>

                    <div class="image-container" id="defaultPlaceholder">
                        <div class="placeholder-text">
                            <h3>Create stunning images with AI</h3>
                            <p>Upload an image and enter your prompt to start</p>
                        </div>
                    </div>
                    
                    <div class="info-panel" id="infoPanel" style="display: none;">
                        <div class="job-id-display" id="jobIdDisplay"></div>
                        <div><strong>Final Prompt:</strong> <span id="finalPrompt"></span></div>
                        <div><strong>System Info:</strong> <span id="systemInfo"></span></div>
                        <div id="warningText" style="color: #f59e0b; margin-top: 0.5rem;"></div>
                    </div>
                </div>
                
                <div class="controls-panel">
                    <div class="control-group">
                        <label class="control-label">Upload Image</label>
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">üì∑</div>
                            <div class="upload-text">Click to upload or drag & drop</div>
                            <div class="upload-text" style="font-size: 0.75rem; margin-top: 0.25rem;">PNG, JPG, WEBP up to 10MB</div>
                        </div>
                        <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
                        
                        <div class="preview-container" id="previewContainer">
                            <img id="previewImage" class="preview-image">
                            <button class="remove-image-btn" onclick="removeImage()">√ó</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Prompt</label>
                        <textarea 
                            class="control-input prompt-textarea" 
                            id="userPrompt" 
                            placeholder="Describe the image you want to generate..."
                        ></textarea>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Style</label>
                        <div class="style-grid">
                            <!-- <div class="style-option active" data-style="Realistic">Realistic</div>
                            <div class="style-option" data-style="Cartoon">Cartoon</div>
                            <div class="style-option" data-style="Cyberpunk">Cyberpunk</div>
                            <div class="style-option" data-style="Minimal">Minimal</div>
                            <div class="style-option" data-style="Vintage">Vintage</div>
                            <div class="style-option" data-style="Anime">Anime</div>
                            <div class="style-option" data-style="Artistic">Artistic</div> -->
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Aspect Ratio</label>
                        <div class="ratio-grid">
                            <div class="ratio-option active" data-ratio="1:1">1:1</div>
                            <div class="ratio-option" data-ratio="2:3">2:3</div>
                            <div class="ratio-option" data-ratio="16:9">16:9</div>
                            <div class="ratio-option" data-ratio="9:16">9:16</div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Quality</label>
                        <div class="quality-grid">
                            <div class="quality-option" data-quality="low">Low</div>
                            <div class="quality-option active" data-quality="medium">Medium</div>
                            <div class="quality-option" data-quality="high">High</div>
                            <div class="quality-option" data-quality="ultra">Ultra</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-content">
                <div class="spinner"></div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="loading-message" id="loadingMessage">Initializing...</div>
                <div class="loading-steps">
                    <div class="loading-step" id="step1">
                        <div class="step-icon">1</div>
                        <span>Processing image & prompt</span>
                    </div>
                    <div class="loading-step" id="step2">
                        <div class="step-icon">2</div>
                        <span>Loading AI model</span>
                    </div>
                    <div class="loading-step" id="step3">
                        <div class="step-icon">3</div>
                        <span>Generating images</span>
                    </div>
                    <div class="loading-step" id="step4">
                        <div class="step-icon">4</div>
                        <span>Finalizing results</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://38f14039d8b3.cn-klmy-1.covacova.co:28443/api/v1/ai';
        
        let currentStyle = 'Realistic';
        let currentRatio = '1:1';
        let currentQuality = 'medium';
        let loadingProgress = 0;
        let loadingInterval;
        let uploadedImageBase64 = null;
        
        const loadingMessages = [
            "Initializing AI models...",
            "Processing your image...",
            "Processing your prompt...",
            "Understanding your vision...",
            "Loading neural networks...",
            "Preparing image generation...",
            "Setting up diffusion model...",
            "Applying style parameters...",
            "Running inference steps...",
            "Creating image layers...",
            "Refining details...",
            "Processing final output...",
            "Almost ready..."
        ];
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            setupDragAndDrop();
        });
        
        function initializeEventListeners() {
            document.querySelectorAll('.style-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.style-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    currentStyle = this.dataset.style;
                });
            });
            
            document.querySelectorAll('.ratio-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.ratio-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    currentRatio = this.dataset.ratio;
                });
            });
            
            document.querySelectorAll('.quality-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.quality-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    currentQuality = this.dataset.quality;
                });
            });
            
            document.getElementById('userPrompt').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    generateImage();
                }
            });
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                });
            });
            
            uploadArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('Image size must be less than 10MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageBase64 = e.target.result.split(',')[1];
                
                const previewImage = document.getElementById('previewImage');
                const previewContainer = document.getElementById('previewContainer');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                
                showSuccess('Image uploaded successfully!');
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImageBase64 = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('previewImage').src = '';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
        
        function setLoading(isLoading) {
            const loading = document.getElementById('loading');
            const generateBtn = document.querySelector('.generate-btn');
            
            if (isLoading) {
                loading.style.display = 'flex';
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                startLoadingProgress();
            } else {
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate';
                stopLoadingProgress();
                resetLoadingState();
            }
        }
        
        function startLoadingProgress() {
            loadingProgress = 0;
            updateLoadingProgress(0);
            updateLoadingStep(1);
            
            loadingInterval = setInterval(() => {
                let progressIncrement;
                if (loadingProgress < 20) {
                    progressIncrement = Math.random() * 8 + 3;
                } else if (loadingProgress < 50) {
                    progressIncrement = Math.random() * 5 + 2;
                } else if (loadingProgress < 80) {
                    progressIncrement = Math.random() * 3 + 1;
                } else if (loadingProgress < 90) {
                    progressIncrement = Math.random() * 2 + 0.5;
                } else {
                    progressIncrement = Math.random() * 0.5;
                    if (loadingProgress >= 95) {
                        loadingProgress = 95;
                        return;
                    }
                }
                
                loadingProgress += progressIncrement;
                
                if (loadingProgress > 95) {
                    loadingProgress = 95;
                }
                
                updateLoadingProgress(loadingProgress);
                updateLoadingMessage();
                updateLoadingSteps();
            }, 1200);
        }
        
        function stopLoadingProgress() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }
        
        function updateLoadingProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressPercentage = document.getElementById('progressPercentage');
            
            progressBar.style.width = `${percentage}%`;
            progressPercentage.textContent = `${Math.round(percentage)}%`;
        }
        
        function updateLoadingMessage() {
            const messageElement = document.getElementById('loadingMessage');
            const messageIndex = Math.floor((loadingProgress / 100) * loadingMessages.length);
            const message = loadingMessages[Math.min(messageIndex, loadingMessages.length - 1)];
            messageElement.textContent = message;
        }
        
        function updateLoadingSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            let currentStepIndex;
            
            if (loadingProgress < 15) {
                currentStepIndex = 0;
            } else if (loadingProgress < 35) {
                currentStepIndex = 1;
            } else if (loadingProgress < 85) {
                currentStepIndex = 2;
            } else if (loadingProgress < 100) {
                currentStepIndex = 3;
            } else {
                currentStepIndex = 4;
            }
            
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                const stepIcon = stepElement.querySelector('.step-icon');
                
                stepElement.classList.remove('active', 'completed');
                stepIcon.classList.remove('active');
                
                if (index < currentStepIndex) {
                    stepElement.classList.add('completed');
                    stepIcon.textContent = '‚úì';
                } else if (index === currentStepIndex && loadingProgress < 100) {
                    stepElement.classList.add('active');
                    stepIcon.classList.add('active');
                    stepIcon.textContent = index + 1;
                } else if (loadingProgress >= 100) {
                    stepElement.classList.add('completed');
                    stepIcon.textContent = '‚úì';
                } else {
                    stepIcon.textContent = index + 1;
                }
            });
        }
        
        function updateLoadingStep(stepNumber) {
            updateLoadingSteps();
        }
        
        function resetLoadingState() {
            loadingProgress = 0;
            updateLoadingProgress(0);
            document.getElementById('loadingMessage').textContent = 'Initializing...';
            
            ['step1', 'step2', 'step3', 'step4'].forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                const stepIcon = stepElement.querySelector('.step-icon');
                stepElement.classList.remove('active', 'completed');
                stepIcon.classList.remove('active');
                stepIcon.textContent = index + 1;
            });
        }

        async function generateImage() {
            const prompt = document.getElementById('userPrompt').value.trim();
            
            if (!prompt) {
                showError('Please enter a prompt');
                return;
            }

            if (!uploadedImageBase64) {
                showError('Please upload an image first');
                return;
            }
            
            const requestData = {
                user_prompt: prompt,
                // style: currentStyle,
                aspect: currentRatio,
                quality: currentQuality,
                input_image: uploadedImageBase64
            };
            
            console.log('Sending request with image');
            console.log(requestData);
            setLoading(true);

            try {
                // 1Ô∏è‚É£ G·ª≠i request t·∫°o job m·ªõi
                const response = await fetch(`${API_BASE_URL}/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // N·∫øu kh√¥ng c√≥ job_id ‚Üí l·ªói
                if (!result.job_id) {
                    throw new Error(result.message || 'No job_id returned from server');
                }

                const jobId = result.job_id;
                console.log('üÜî Job ID:', jobId);
                document.getElementById('loadingMessage').textContent = 'Queued... Waiting to start.';

                let isCompleted = false;
                let attempts = 0;

                // 2Ô∏è‚É£ Polling API status m·ªói 5 gi√¢y
                while (!isCompleted && attempts < 60) { // t·ªëi ƒëa 5 ph√∫t
                    const statusUrl = `${API_BASE_URL.replace('/generate-image', '')}/ai-generate-status/${jobId}`;
                    const statusResp = await fetch(statusUrl);
                    const statusData = await statusResp.json();

                    console.log('üîÑ Checking job status:', statusData.status);

                    if (statusData.status === 'completed') {
                        isCompleted = true;
                        loadingProgress = 100;
                        updateLoadingProgress(loadingProgress);
                        updateLoadingSteps();
                        document.getElementById('loadingMessage').textContent = 'Complete!';
                        await new Promise(resolve => setTimeout(resolve, 800));
                        console.log('‚úÖ Image generation completed:', statusData);
                        // 3Ô∏è‚É£ Hi·ªÉn th·ªã ·∫£nh t·ª´ URL
                        if (statusData.file_path) {
                            displayImage({statusData});
                            showSuccess('Image generated successfully!');
                        } else {
                            showError('Image completed but no file_path found.');
                        }
                        break;

                    } else if (statusData.status === 'failed') {
                        showError(statusData.error_message || 'Image generation failed.');
                        break;

                    } else if (statusData.status === 'processing') {
                        document.getElementById('loadingMessage').textContent = 'Processing...';
                    } else if (statusData.status === 'queued') {
                        const pos = statusData.queue_position ?? 'unknown';
                        document.getElementById('loadingMessage').textContent = `Queued (position ${pos})...`;
                    }

                    // c·∫≠p nh·∫≠t ti·∫øn tr√¨nh gi·∫£ ƒë·ªãnh (cho animation)
                    loadingProgress = Math.min(95, loadingProgress + 3);
                    updateLoadingProgress(loadingProgress);

                    await new Promise(resolve => setTimeout(resolve, 5000)); // ƒë·ª£i 5 gi√¢y r·ªìi check l·∫°i
                    attempts++;
                }

                if (!isCompleted) {
                    showError('Timeout: image generation took too long.');
                }

            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Failed to generate image. Please check your connection and try again.');
            } finally {
                setLoading(false);
            }
        }
        
        // function displayImage(result) {
        //     const container = document.getElementById('imageContainer');
        //     const placeholder = document.getElementById('placeholder');
        //     const infoPanel = document.getElementById('infoPanel');
        //     const jobIdDisplay = document.getElementById('jobIdDisplay');
            
        //     // Hide placeholder
        //     placeholder.style.display = 'none';
            
        //     // Create or update image
        //     let img = container.querySelector('img');
        //     if (!img) {
        //         img = document.createElement('img');
        //         container.appendChild(img);
        //     }
            
        //     img.src = `data:image/png;base64,${result.image_base64}`;
        //     img.style.display = 'block';
            
        //     // Wait for image to load to get its natural dimensions
        //     img.onload = function() {
        //         const naturalAspectRatio = this.naturalWidth / this.naturalHeight;
        //         console.log(`Image loaded: ${this.naturalWidth}x${this.naturalHeight}, aspect: ${naturalAspectRatio}`);
                
        //         // Update container to match the actual image aspect ratio
        //         container.style.aspectRatio = naturalAspectRatio.toString();
        //     };
            
        //     // Update info panel
        //     if (result.job_id) {
        //         jobIdDisplay.textContent = `Job ID: ${result.job_id}`;
        //         jobIdDisplay.style.display = 'block';
        //     } else {
        //         jobIdDisplay.style.display = 'none';
        //     }
            
        //     if (result.final_prompt) {
        //         document.getElementById('finalPrompt').textContent = result.final_prompt;
        //     }
        //     if (result.system_info) {
        //         document.getElementById('systemInfo').textContent = result.system_info;
        //     }
        //     if (result.warning) {
        //         document.getElementById('warningText').textContent = result.warning;
        //     }
            
        //     infoPanel.style.display = 'block';
        // }
        function displayImage(result) {
            console.log('Displaying images from result:', result);

            const imagesGrid = document.getElementById('imagesGrid');
            const defaultPlaceholder = document.getElementById('defaultPlaceholder');
            const imageContainer1 = document.getElementById('imageContainer1');
            const imageContainer2 = document.getElementById('imageContainer2');
            const infoPanel = document.getElementById('infoPanel');
            const jobIdDisplay = document.getElementById('jobIdDisplay');

            // ·∫®n placeholder m·∫∑c ƒë·ªãnh v√† hi·ªÉn th·ªã grid
            defaultPlaceholder.style.display = 'none';
            imagesGrid.style.display = 'grid';

            // X√≥a n·ªôi dung c≈©
            imageContainer1.innerHTML = '';
            imageContainer2.innerHTML = '';

            // N·∫øu c√≥ nhi·ªÅu ƒë∆∞·ªùng d·∫´n ·∫£nh (v√≠ d·ª• file_path_1, file_path_2)
            // th√¨ hi·ªÉn th·ªã c·∫£ hai, n·∫øu kh√¥ng th√¨ ch·ªâ hi·ªÉn th·ªã m·ªôt
            if (result.file_path_1 || result.file_path) {
                const link1 = document.createElement('a');
                link1.href = result.file_path_1 || result.file_path;
                link1.textContent = `Image 1: ${link1.href}`;
                link1.target = '_blank';
                imageContainer1.appendChild(link1);
            } else {
                imageContainer1.textContent = 'No Image 1 URL available';
            }

            if (result.file_path_2) {
                const link2 = document.createElement('a');
                link2.href = result.file_path_2;
                link2.textContent = `Image 2: ${link2.href}`;
                link2.target = '_blank';
                imageContainer2.appendChild(link2);
            } else {
                imageContainer2.textContent = 'No Image 2 URL available';
            }

            // Hi·ªÉn th·ªã Job ID n·∫øu c√≥
            if (result.job_id) {
                jobIdDisplay.textContent = `Job ID: ${result.job_id}`;
                jobIdDisplay.style.display = 'block';
            } else {
                jobIdDisplay.style.display = 'none';
            }

            // C·∫≠p nh·∫≠t th√¥ng tin th√™m
            if (result.file_path) {
                document.getElementById('finalPrompt').textContent = `File path: ${result.file_path}`;
            }
            if (result.system_info) {
                document.getElementById('systemInfo').textContent = result.system_info;
            }
            if (result.warning) {
                document.getElementById('warningText').textContent = result.warning;
            }

            infoPanel.style.display = 'block';
        }


        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                generateImage();
            }
        });
    </script>
</body>
</html>